# -*- coding: utf-8 -*-
"""
@author: Salvatore Iacoletti
"""

import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
from matplotlib.animation import FuncAnimation
import openseespy.opensees as ops
from pysequentialvulnerability.base_sdof import (geometry,
                                                 material_martins_silva,
                                                 cyclic_loading_analysis, 
                                                 get_sinewave)


if __name__ == '__main__':
    
    # base = r"C:\Users\Salvatore\Documents\GitHub/"
    base = r"C:\Users\Salvatore\Dropbox\SalvIac/"
    filepath = base+r"global_fragility_vulnerability\capacity/CR_LDUAL-DUH_H1.csv" # SRC_LDUAL-DUH_H1
    capacity_curve = pd.read_csv(filepath).to_numpy()
    degradation = True
    
    
    #%% simple sinewave just below failure point
    
    ops.wipe()
    material_martins_silva(capacity_curve, degradation=degradation)
    geometry()
    
    time, sinewave = get_sinewave(amplitude=capacity_curve[-1,0]*0.9, dt=1e-2)
    outputs = cyclic_loading_analysis(sinewave)

    fig, axs = plt.subplots(2,1)
    axs[0].plot(capacity_curve[:,0], capacity_curve[:,1]*9.81, marker="o", markersize=2)
    axs[0].plot(outputs["disp"], outputs["force"], marker="o", markersize=2)
    axs[0].set_xlabel("Displacement [m]")
    axs[0].set_ylabel("Base shear [kN]")
    axs[1].plot(time, sinewave, marker="o")
    axs[1].set_xlabel("Time [s]")
    axs[1].set_ylabel("Displacement [m]")
    plt.show()


    #%% simple sinewave just above failure point
    
    ops.wipe()
    material_martins_silva(capacity_curve, degradation=degradation)
    geometry()
    
    time, sinewave = get_sinewave(amplitude=capacity_curve[-1,0]*1.1, dt=1e-2)
    outputs = cyclic_loading_analysis(sinewave)

    fig, axs = plt.subplots(2,1)
    axs[0].plot(capacity_curve[:,0], capacity_curve[:,1]*9.81, marker="o", markersize=2)
    axs[0].plot(outputs["disp"], outputs["force"], marker="o", markersize=2)
    axs[0].set_xlabel("Displacement [m]")
    axs[0].set_ylabel("Base shear [kN]")
    axs[1].plot(time, sinewave, marker="o", markersize=2)
    axs[1].set_xlabel("Time [s]")
    axs[1].set_ylabel("Displacement [m]")
    plt.show()


    #%% incremental sinewave with animation
    
    ops.wipe()
    material_martins_silva(capacity_curve, degradation=degradation)
    geometry()

    ampls = np.linspace(0, capacity_curve[-1,0]*1.2, len(time))
    time, sinewave = get_sinewave(amplitude=ampls, dt=1e-2)
    outputs = cyclic_loading_analysis(sinewave)
    
    fig, axs = plt.subplots(2,1)
    axs[0].plot(capacity_curve[:,0], capacity_curve[:,1]*9.81, marker="o", markersize=2)
    axs[0].plot(outputs["disp"], outputs["force"], marker="o", markersize=2)
    axs[0].set_xlabel("Displacement [m]")
    axs[0].set_ylabel("Base shear [kN]")
    axs[1].plot(time, sinewave, marker="o", markersize=2)
    axs[1].set_xlabel("Time [s]")
    axs[1].set_ylabel("Displacement [m]")
    plt.show()
    
    
    # animation
    fig, axs = plt.subplots(2,1)
    axs[0].set_xlim(-capacity_curve[-1,0]*1.1, capacity_curve[-1,0]*1.1)
    axs[0].set_ylim(-capacity_curve[-1,1]*1.1*9.81, capacity_curve[-1,1]*1.1*9.81)
    axs[0].set_xlabel("Displacement [m]")
    axs[0].set_ylabel("Base shear [kN]")
    axs[1].set_xlim(0,10)
    axs[1].set_ylim(-capacity_curve[-1,0]*1.2,capacity_curve[-1,0]*1.2)
    axs[1].set_xlabel("Time [s]")
    axs[1].set_ylabel("Displacement [m]")
    axs[0].plot(capacity_curve[:,0], capacity_curve[:,1]*9.81, marker="o",
                color="r", markersize=2)
    def animate(i):
        axs[0].plot(outputs["disp"][:i], outputs["force"][:i], marker="o",
                    color="b", markersize=2)
        axs[1].plot(time[:i], sinewave[:i], marker="o", color="b", 
                    markersize=2)
    anim = FuncAnimation(fig, animate,# init_func=init,
                         frames=outputs["disp"].shape[0],
                         interval=outputs["disp"].shape[0]/10)
    plt.show()
    
    ss
    anim.save('cyclic2.gif', writer='imagemagick')
        
        
    
