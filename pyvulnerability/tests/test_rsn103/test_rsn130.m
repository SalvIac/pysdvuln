clear
clc
% close all

%% comparison spectra SRSS
srss_peer = [0.14476803,0.14600606,0.14750326,0.14753086,0.14871466,0.14838446,0.15141080,0.15587738,0.15664023,0.15218728,0.15769724,0.16776352,0.17222623,0.17329912,0.16704796,0.15919721,0.17731718,0.18753220,0.19158463,0.20812948,0.23834748,0.23465565,0.21530944,0.21223911,0.21329274,0.21850626,0.20517850,0.21309219,0.26525637,0.26093772,0.25459093,0.23618779,0.25526258,0.28368426,0.32587889,0.35012811,0.40924340,0.39640702,0.30541113,0.27820983,0.31087770,0.33833437,0.36591415,0.36292845,0.35158530,0.32685773,0.29137923,0.27582574,0.26204441,0.27084475,0.28052865,0.27275315,0.25561317,0.24924052,0.24373661,0.24397550,0.25331730,0.30933598,0.36810203,0.39872853,0.40147030,0.39659767,0.36992975,0.32835124,0.27847644,0.24061194,0.22913041,0.21231036,0.15317888,0.13074625,0.12669943,0.13166375,0.13959059,0.14206358,0.12860452,0.12353130,0.11181110,0.095302740,0.065205800,0.051527880,0.046682490,0.042322640,0.035657120,0.030637990,0.026887420,0.024633540,0.023058690,0.022029710,0.019556800,0.015936600,0.013834140,0.012323680,0.010517740,0.0087301800,0.0076723800,0.0057989400,0.0047056200,0.0039726200,0.0033835300,0.0029037900,0.0025112000,0.0021882600,0.0019207800,0.0016974800,0.0015096800]';
T = [0.0100,0.0200,0.0220,0.0250,0.0290,0.0300,0.0320,0.0350,0.0360,0.0400,0.0420,0.0440,0.0450,0.0460,0.0480,0.0500,0.0550,0.0600,0.0650,0.0670,0.0700,0.0750,0.0800,0.0850,0.0900,0.0950,0.100,0.110,0.120,0.130,0.133,0.140,0.150,0.160,0.170,0.180,0.190,0.200,0.220,0.240,0.250,0.260,0.280,0.290,0.300,0.320,0.340,0.350,0.360,0.380,0.400,0.420,0.440,0.450,0.460,0.480,0.500,0.550,0.600,0.650,0.667,0.700,0.750,0.800,0.850,0.900,0.950,1,1.10,1.20,1.30,1.40,1.50,1.60,1.70,1.80,1.90,2,2.20,2.40,2.50,2.60,2.80,3,3.20,3.40,3.50,3.60,3.80,4,4.20,4.40,4.60,4.80,5,5.50,6,6.50,7,7.50,8,8.50,9,9.50,10]';
fn = 1./T;

filename = 'RSN130_FRIULI.B_B-BUI000.AT2';
[acc1, t1, dt1, description1] = importNGAWest(filename);
Tnfn_SAVD1 = CalResponseSpectra_SP(fn, dt1, acc1, 0.05, 9.81);
filename = 'RSN130_FRIULI.B_B-BUI270.AT2';
[acc2, t2, dt2, description2] = importNGAWest(filename);
Tnfn_SAVD2 = CalResponseSpectra_SP(fn, dt2, acc2, 0.05, 9.81);

spect_1 = Tnfn_SAVD1(:,3);
spect_2 = Tnfn_SAVD2(:,3);
srss = sqrt(spect_1.^2 + spect_2.^2);

figure
plot(T,spect_1); hold on
plot(T,spect_2);
plot(T,srss);
plot(T,srss_peer,'--');
% plot(T,Rot50);
legend('comp 1', 'comp 2', 'SRSS', 'SRSS PEER')
set(gca,'Fontsize',12)%,'YScale','log') ,'XScale','log'

%% comparison velocity and displacement time history

% from peer
filename = 'RSN130_FRIULI.B_B-BUI000.VT2';
[vel_peer, t, dt, ~] = importNGAWest(filename);
filename = 'RSN130_FRIULI.B_B-BUI000.DT2';
[disp1_peer, t, ~, ~] = importNGAWest(filename);

vel = cumsum(acc1*9.81).*dt1;
vel = detrend(vel)*100;
t_vel = 0:dt:(length(vel)-1)*dt;
disp = cumsum(vel).*dt;  % compute displacement
t_dis = 0:dt:(length(disp)-1)*dt;

figure
plot(t,vel_peer); hold on
plot(t_vel,vel,'--');

figure
plot(t,disp1_peer); hold on
plot(t_dis,disp,'--');


%%

% import nga west 2
function [Output,t,dt,description] = importNGAWest(filename)

% acceleration/velocity/displacement time history
startRow = 5;
formatSpec = '%15f%15f%15f%15f%f%[^\n\r]';
fileID = fopen(filename,'r');
dataArray = textscan(fileID, formatSpec, 'Delimiter', '', 'WhiteSpace', '', 'TextType', 'string', 'HeaderLines' ,startRow-1, 'ReturnOnError', false, 'EndOfLine', '\r\n');
fclose(fileID);
Output = [dataArray{1:end-1}];
clearvars startRow formatSpec fileID dataArray ans;
Output = reshape(Output',[],1);
Output(isnan(Output)) = [];

% delta t and total t
startRow = 4; endRow = 4;
formatSpec = '%*18s%9f%[^\n\r]';
fileID = fopen(filename,'r');
dataArray = textscan(fileID, formatSpec, endRow-startRow+1, 'Delimiter', '', 'WhiteSpace', '', 'TextType', 'string', 'HeaderLines', startRow-1, 'ReturnOnError', false, 'EndOfLine', '\r\n');
fclose(fileID);
dt = [dataArray{1:end-1}];
clearvars startRow endRow formatSpec fileID dataArray ans;
t = [0:dt:length(Output)*dt-dt]';

startRow = 2; endRow = 2;
formatSpec = '%s%[^\n\r]';
fileID = fopen(filename,'r');
dataArray = textscan(fileID, formatSpec, endRow-startRow+1, 'Delimiter', '', 'WhiteSpace', '', 'TextType', 'string', 'HeaderLines', startRow-1, 'ReturnOnError', false, 'EndOfLine', '\r\n');
dataArray{1} = strtrim(dataArray{1});
fclose(fileID);
description = [dataArray{1:end-1}];
clearvars startRow endRow formatSpec fileID dataArray ans;

end
