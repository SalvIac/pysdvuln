# -*- coding: utf-8 -*-
"""
@author: Salvatore Iacoletti
"""

from copy import deepcopy
import pandas as pd
from tqdm import tqdm
from myutils.utils_pickle import save_pickle, load_pickle
from pyvulnerability.opensees_runner import OpenseesRunner
from pyvulnerability.damage_state_classif import DamageStateClassif
from pyvulnerability.psdm_gg21 import PSDM_gg21
from pyvulnerability.damg_dep_frag_curves import DamgDepFragCurves


if __name__ == "__main__":
    
    capacity_curve = pd.read_csv("capacity_curve.csv").to_numpy()
    opr = OpenseesRunner(capacity_curve)
    dsc = DamageStateClassif(opr.capacity_curve)

    #%% run all selected ground motions with opensees    
    
    # rec_pairs = load_pickle(r"C:\Users\Salvatore\Dropbox\SalvIac\pyvulnerability\pyvulnerability\tests\test_fragility\selection_T_1_987\nga_800_rec_pairs")
    # res = list()
    # for i, rec in tqdm(enumerate(rec_pairs)):
    #     _ = opr.run(rec["rp"].get_time_gmr(unit="m/s2"), mat="Steel01")
    #     res.append( deepcopy(rec) )
    #     res[-1]["opr"] = deepcopy(opr)
    # save_pickle(res, "nltha")
    res = load_pickle("nltha")
    
    #%% PSDM and fragility curves from Gentile and Galasso (2021)

    psdm = PSDM_gg21(res, dsc)
    psdm.check_plots()
    
    ddfc = DamgDepFragCurves(psdm, dsc)
    ddfc.check_plots()
    
    