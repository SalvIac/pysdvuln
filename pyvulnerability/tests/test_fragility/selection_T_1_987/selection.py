# -*- coding: utf-8 -*-
"""
@author: Salvatore Iacoletti
"""

import os
import numpy as np
import pandas as pd
from myutils.utils_pickle import save_pickle, load_pickle
from pyvulnerability.records_container import RecordsContainer
from pyvulnerability.record_pair import RecordPair
from pyvulnerability.selector import Selector


if __name__ == "__main__":
   
    base = r"C:\Users\Salvatore\Dropbox\SalvIac\pyvulnerability\ground_motion_databases"
    
    # rc = RecordsContainer.load_simbad_data(base)
    # name = "simbad"
    
    rc = RecordsContainer.load_ngawest2_data(base)
    rsns = rc.get_array("rsn")
    df = pd.read_csv(os.path.join(base, "NGAWest2", "pulse_like_peer.csv"))
    pulse_rsn = df['Record Seq. #'].to_list()
    del_i = [i for i, rsn in enumerate(rsns) if rsn in pulse_rsn]
    print(len(rc.records))
    rc.delete_records(del_i)
    name = "nga"

    # other filters
    print(len(rc.records))
    rc.filter_sign_duration(1)
    print(len(rc.records))
    
    
    fund_period = 1.9869176517087703
    ravg = rc.get_avgsas_T(fund_period)
    ims = ravg


    #%% simulating annealing selection

    sel = Selector(ims, rc, "avgSA(1.987) (m/s2)")
    n = 800

    # inds1, inds2, sf1, sf2, sample2d = sel.simul_ann(n)
    # save_pickle((inds1, inds2, sf1, sf2, sample2d), name+"_"+str(n)+"_sel")
    (inds1, inds2, sf1, sf2, sample2d) = load_pickle(name+"_"+str(n)+"_sel")
    
    # plots selection
    sel.scatter(sample2d[:,0], sample2d[:,1], edgecolors='k')
    sel.hist2d(sample2d, bar_width=0.5, range_bin=[0., sel.max_im])
    
    # save for livio and for me
    records = list()
    rec_pairs = list()
    for i, (ind1, ind2, s1, s2) in enumerate(zip(inds1, inds2, sf1, sf2)):
        rp = RecordPair(rc.records[ind1], rc.records[ind2], 50., s1, s2)
        records.append( {"ground_motion": rp.get_time_gmr(unit="m/s2"),
                      "ind1": ind1, "ind2": ind2, "s1": s1, "s2": s2,
                      "im_g1": sample2d[i,0], "im_g2": sample2d[i,1]} )
        rec_pairs.append( {"rp": rp,
                           "ind1": ind1, "ind2": ind2, "s1": s1, "s2": s2,
                           "im_g1": sample2d[i,0], "im_g2": sample2d[i,1]} )
    save_pickle(records, name+"_"+str(n)+"_gms")
    save_pickle(rec_pairs, name+"_"+str(n)+"_rec_pairs")
    
    